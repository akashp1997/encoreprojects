{% extends 'base.html' %}

{% block content %}
    {% if form_load == False %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <span class="alert-icon"><i class="ni ni-like-2"></i></span>
            <span class="alert-text">The row has been added</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    {% endif %}
    <div class="alert alert-danger alert-dismissible fade" role="alert">
        <span class="alert-icon"><i class="ni ni-like-2"></i></span>
        <span class="alert-text"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-header pb-0">
                        <h6 class="text-uppercase">EFU Detail</h6>
                    </div>
                    <div class="card-description">
                        <dl class="row">
                            <dt class="col-sm-4 col-lg-2 text-end">Purchase order</dt>
                            <dd class="col-sm-4 col-lg-2 text-start">
                                {{ project.po_code }}
                            </dd>
                            <dt class="col-sm-4 col-lg-2 text-end">Creation date</dt>
                            <dd class="col-sm-4 col-lg-2 text-start">
                                {{ project.po_date|date:"d/m/Y" }}
                            </dd>
                        </dl>
                        <dl class="row">
                            <dt class="col-sm-4 col-lg-2 text-end">Addendum</dt>
                            <dd class="col-sm-4 col-lg-2 text-start">
                                {{ project.addendum }}
                            </dd>
                            <dt class="col-sm-4 col-lg-2 text-end">Project</dt>
                            <dd class="col-sm-4 col-lg-2 text-start">
                                {{ project.name }}
                            </dd>
                        </dl>
                        <dl class="row">
                            <dt class="col-sm-4 col-lg-2 text-end">Supplier</dt>
                            <dd class="col-sm-4 col-lg-2 text-start">
                                {{ project.supplier_name }}
                            </dd>
                            <dt class="col-sm-4 col-lg-2 text-end">Efu submission date/revision</dt>
                            <dd class="col-sm-4 col-lg-2 text-start">
                                {{ project.modified_date }}
                            </dd>
                        </dl>
                        <dl class="row">
                            <dt class="col-sm-4 col-lg-2 text-end">Technical specification</dt>
                            <dd class="col-sm-4 col-lg-2 text-start">
                                {{ project.po_spec }}
                            </dd>
                            <dt class="col-sm-4 col-lg-2 text-end">Technical specification description</dt>
                            <dd class="col-sm-4 col-lg-2 text-start">
                                {{ project.description }}
                            </dd>
                        </dl>
                    </div>
                    <div class="card-body px-0 pt-0 pb-2">
                        <div class="d-flex justify-content-evenly flex-row m-6 table-toolbar">
                            <div class="card p-2 d-flex flex-row">
                                <button class="btn btn-outline-success btn-icon mb-0 mx-2 export-xlsx">
                                    <span class="btn-inner--icon">
                                        <i class="fa-solid fa-file-excel"></i>
                                    </span>
                                    <span class="btn-inner--text">Export</span>
                                </button>
                                <button class="btn btn-outline-success btn-icon mb-0 mx-2 export-xlsx-selected">
                                    <span class="btn-inner--icon">
                                        <i class="fa-solid fa-file-excel"></i>
                                    </span>
                                    <span class="btn-inner--text">Filtered Export</span>
                                </button>
                                <button class="btn btn-outline-success btn-icon mb-0 mx-2">
                                    <span class="btn-inner--icon">
                                        <i class="fa-solid fa-file-excel"></i>
                                    </span>
                                    <span class="btn-inner--text">Import</span>
                                </button>
                            </div>
                            <div class="card p-2 d-flex flex-row">
                                <button type="button" class="btn btn-outline-secondary btn-icon mb-0 mx-2 add-item" id="addItemModalBtn" data-bs-toggle="modal" data-bs-target="#addItemModal">
                                    <span class="btn-inner--icon">
                                        <i class="fa-solid fa-plus"></i>
                                    </span>
                                    <span class="btn-inner--text">Add item</span>
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-icon mb-0 mx-2 delete-item" disabled data-bs-toggle="modal" data-bs-target="#deleteItemModal">
                                    <span class="btn-inner--icon">
                                        <i class="fa-solid fa-trash"></i>
                                    </span>
                                    <span class="btn-inner--text">Delete item</span>
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive table-bordered table-striped table-striped-columns my-4" id="bbuTable"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="addItemModal" tabindex="-1" role="dialog" aria-labelledby="addItemModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addItemModalLabel">Add an item</h5>
                    <button type="button" class="btn-lg btn-outline-white border-0" data-bs-dismiss="modal" aria-label="Close">
                        <span class="text-dark text-2xl" aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="post">
                    <div class="modal-body">
                        {% csrf_token %}
                        {% for non_field_error in form.non_field_errors %}
                            <div class="invalid-feedback">
                                {{ non_field_error|escape }}
                            </div>
                        {% endfor %}
                        {% for field in form %}
                            <div class="row">
                                <div class="col-12">
                                    <div class="form-group">
                                        <label for="{{ field.id_for_label }}" class="form-control-label">{{ field.label }}</label>
                                        {% if field.widget_type == 'textarea' %}
                                            <textarea
                                                    class="form-control {% if field.errors %}is-invalid{% elif field.data %}is-valid{% endif %}"
                                                    name="{{ field.html_name }}"
                                                    id="{{ field.id_for_label }}"
                                                    placeholder="{{ field.help_text }}"
                                            >{% if field.data %}{{ field.data }}{% else %}{{ field.initial|default_if_none:"" }}{% endif %}</textarea>
                                        {% else %}
                                            <input
                                                type="{{ field.widget_type }}"
                                                class="form-control {% if field.errors %}is-invalid{% elif field.data %}is-valid{% endif %}"
                                                name="{{ field.html_name }}"
                                                id="{{ field.id_for_label }}"
                                                placeholder="{{ field.help_text }}"
                                                {% if field.data %}
                                                    value="{{ field.data }}"
                                                {% else %}
                                                    {% if field.widget_type == 'date' %}
                                                        value="{% now 'Y-m-d' %}"
                                                    {% else %}
                                                        value="{{ field.initial|default_if_none:"" }}"
                                                    {% endif %}
                                                {% endif %}
                                            />
                                        {% endif %}
                                        {% for field_error in field.errors %}
                                            <div class="invalid-feedback">
                                                {{ field_error }}
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="modal-footer">
                        <button type="reset" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-info bg-gradient-info">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal fade" id="editItemModal" tabindex="-1" role="dialog" aria-labelledby="editItemModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editItemLabel">Edit EFU item</h5>
                    <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                        <span class="text-dark" aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    ...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn bg-gradient-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="deleteItemModal" tabindex="-1" role="dialog" aria-labelledby="deleteItemModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteItemModalLabel">Are you sure?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete the following items?
                    <ul class="delete-item-list"></ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn bg-gradient-danger deleteItemButton" data-bs-dismiss="modal">Delete</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
      let deleteItems = async (data) => {
        try {
          await fetch("{% url 'delete-bbu-rows' project.po_code %}", {
            method: "DELETE",
            mode: "cors",
            cache: "no-cache",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": Cookies.get('csrftoken')
            },
            body: JSON.stringify(data)
          });
          window.location.reload();
        } catch (error) {
          let alertElemText = $(".alert-danger .alert-text");
          alertElemText.empty();
          alertElemText.text(error);
          $(".alert-danger").addClass("show");
        }
      };
        let data = [
          {% for bbu_row in bbu_list %}
            {
              "id": {{ bbu_row.id }},
              "po_line_item_no": {{ bbu_row.po_line_item_no }},
              "po_position_no": {{ bbu_row.po_position_no }},
              "erection_item": "{{ bbu_row.erection_item }}",
              "description": "{{ bbu_row.description }}",
              "supplier_identification_no": "{{ bbu_row.supplier_identification_no }}",
              "uom": "{{ bbu_row.uom }}",
              "quantity": {{ bbu_row.quantity }},
              "bbu_value": {{ bbu_row.bbu_value }}
            }
            {% if not forloop.last %},{% endif %}
          {% endfor %}
        ];
        let columnDefaults = {
          hozAlign: "left",
          vertAlign: "middle",
          formatter: "plaintext",
          resizable: true,
          titleFormatter: (cell) => {
            cell.getElement().classList.add("text-md","font-weight-bolder")
            return cell.getValue()
          },
          sorter: "string"
        };
        let columns = [
          {
            title: "Select",
            formatter:"rowSelection",
            titleFormatter:"rowSelection",
            align:"center",
            headerSort:false,
            resizable: false,
            maxWidth: 30
          },
          {
            title: "PO line item",
            field: "po_line_item_no"
          },
          {
            title: "PO pos.",
            field: "po_position_no"
          },
          {
            title: "Erection item",
            field: "erection_item"
          },
          {
            title: "Description",
            field: "description"
          },
          {
            title: "Supplier id. no.",
            field: "supplier_identification_no"
          },
          {
            title: "UoM",
            field: "uom"
          },
          {
            title: "Required qty",
            field: "quantity"
          },
          {
            title: "BBU value",
            field: "bbu_value"
          }
        ];
        let bbuTable = new Tabulator("#bbuTable", {
          data,
          clipboard: "copy",
          columnDefaults,
          columns,
          downloadRowRange: "visible",
          initialSort: [
            {column: "po_line_item_no", dir: "asc"},
            {column: "po_position_no", dir: "asc"}
          ],
          layout: "fitColumns",
          minHeight: 100,
          persistence: {
            sort: true
          },
          persistenceMode: true,
          placeholder: "No items added",
          resizableRows: false,
          rowContextMenu: [
            {
              label: "Edit item",
              action: (event, row) => {

              }
            },
            {
              label: "Delete item",
              action: (event, row) => {
                deleteItems([row._row.data]);
              }
            }
          ],
          selectable: true
        });

        // Load the modal if required
        {% if form_load %}
            $("#addItemModalBtn").click()
        {% endif %}

        $(".export-xlsx").on("click", () => table.download("xlsx", "efu.xlsx", {}, "visible"));
        $(".export-xlsx-selected").on("click", () => table.download("xlsx", "efu.xlsx", {}, "selected"));

        bbuTable.on("rowSelectionChanged", (data) => {
          $(".delete-item").prop("disabled", data.length === 0);
        });
        $(".delete-item").on("click", () => {
          let deleteItemList = $(".delete-item-list");
          deleteItemList.empty();
          $.each(bbuTable.getSelectedData(), (index, data) => {
            deleteItemList.append(`<li class="text-bold">${data.erection_item}</li>`);
          });
          $("#deleteItemModal .deleteItemButton").on("click", async () => await deleteItems(bbuTable.getSelectedData()));
        });
    </script>
{% endblock %}
